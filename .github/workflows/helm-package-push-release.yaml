name: Helm Package, Push & (Conditional) Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      tag:
        description: "The tag to use for packaging (must be provided when triggered manually)."
        required: true

permissions:
  contents: write # Required for creating GitHub releases

jobs:
  package-push-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Helm Toolchain
        uses: azure/setup-helm@v4
        with:
          version: "4.0.0"

      - name: Determine Versions
        id: versions
        run: |
          # Extract chart name and version from Chart.yaml in the repository root.
          CHART_VERSION=$(awk -F": " '/^version:/{print $2}' Chart.yaml | tr -d '[:space:]')
          CHART_NAME=$(awk -F": " '/^name:/{print $2}' Chart.yaml | tr -d '[:space:]')
          echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_ENV
          echo "CHART_NAME=$CHART_NAME" >> $GITHUB_ENV

          # Use the tag from the triggerâ€”manual input (workflow_dispatch) or push event.
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            EFFECTIVE_VERSION="${{ github.event.inputs.tag }}"
          else
            EFFECTIVE_VERSION="${GITHUB_REF##*/}"
          fi
          echo "EFFECTIVE_VERSION=$EFFECTIVE_VERSION" >> $GITHUB_ENV

      # The following step is necessary even dependencies are not used.
      - name: Update Chart Dependencies
        run: helm dependency update .

      - name: Package Helm Chart
        run: |
          echo "Packaging chart with version $EFFECTIVE_VERSION"
          helm package . --version "$EFFECTIVE_VERSION"

      - name: Login to Harbor Registry (OCI)
        run: |
          echo '${{ secrets.ECMWF_DOCKER_REGISTRY_ACCESS_TOKEN }}' | \
          helm registry login eccr.ecmwf.int \
          --username '${{ secrets.ECMWF_DOCKER_REGISTRY_USERNAME }}' \
          --password-stdin

      - name: Push Packaged Chart
        run: |
          PACKAGE_FILE="${{ env.CHART_NAME }}-${{ env.EFFECTIVE_VERSION }}.tgz"
          echo "Pushing package file: $PACKAGE_FILE"
          helm push "$PACKAGE_FILE" oci://eccr.ecmwf.int/polytope

      - name: Create GitHub Release if Tag Equals Chart Version
        if: ${{ env.EFFECTIVE_VERSION == env.CHART_VERSION }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.EFFECTIVE_VERSION }}
          name: "${{ env.CHART_NAME }} v${{ env.EFFECTIVE_VERSION }}"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
